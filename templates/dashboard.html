<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dashboard de Reclamos 2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; font-family: "Segoe UI", Roboto, Arial, sans-serif; padding: 20px; }
    .header { text-align: center; margin-bottom: 20px; }
    .card-dark { background: #1e2836; color: #fff; border: none; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    .card-dark .card-body { padding: 18px; }
    .summary-title { font-size: 0.95rem; color: #cbd5e1; }
    .summary-value { font-size: 1.6rem; font-weight: 700; margin-top: 6px; }
    .filter-bar { background: white; padding: 12px; border-radius: 10px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
    .table-compact td, .table-compact th { padding: 8px; }
    .badge-razon { font-size: 0.85rem; color:#fff; background:#3b82f6; padding:4px 8px; border-radius:6px; }
    .no-data { color: #666; padding: 18px; }
    /* colores para avisos/alertas */
    .row-aviso { background: #fff7e6; }
    .row-alerta { background: #fff0f3; }
    .card-section { margin-bottom: 16px; }
    .filters-select { min-width: 160px; margin-right: 8px; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="header">
      <img src="/static/LogoCarre.png" alt="logo" height="48">
      <h2 class="mt-2">Dashboard de Reclamos 2025</h2>
    </div>

    <!-- filtros -->
    <div class="filter-bar d-flex align-items-center justify-content-start mb-3 flex-wrap">
      <div class="me-2">
        <label class="form-label mb-0 small">Mes</label>
        <select id="filter-mes" class="form-select filters-select">
          <option value="">Todos</option>
          {% for m in meses %}
            <option value="{{ m }}">{{ m }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="me-2">
        <label class="form-label mb-0 small">Sub Tipo Caso</label>
        <select id="filter-subtipo" class="form-select filters-select">
          <option value="">Todos</option>
          {% for s in sub_tipos %}
            <option value="{{ s }}">{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="me-2">
        <label class="form-label mb-0 small">Definici√≥n Calidad</label>
        <select id="filter-def" class="form-select filters-select">
          <option value="">Todos</option>
          {% for d in definiciones %}
            <option value="{{ d }}">{{ d }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="ms-3">
        <button id="btn-apply" class="btn btn-primary" style="margin-top:18px;">Aplicar filtros</button>
        <button id="btn-reset" class="btn btn-outline-secondary" style="margin-top:18px; margin-left:8px;">Reset</button>
      </div>
    </div>

    <!-- tarjetas resumen -->
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="card card-dark">
          <div class="card-body">
            <div class="summary-title">Total Reclamos</div>
            <div id="total-reclamos" class="summary-value">{{ total_reclamos }}</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card" style="background:#fff3cd;">
          <div class="card-body">
            <div class="summary-title">‚ö†Ô∏è Avisos</div>
            <div id="total-avisos" class="summary-value">{{ total_avisos }}</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card" style="background:#f8d7da;">
          <div class="card-body">
            <div class="summary-title">üö® Alertas</div>
            <div id="total-alertas" class="summary-value">{{ total_alertas }}</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card card-dark">
          <div class="card-body">
            <div class="summary-title">üè∑Ô∏è Proveedor con m√°s reclamos</div>
            <div id="proveedor-top" class="summary-value">{{ proveedor_top }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- graficos proveedor / producto -->
    <div class="row card-section">
      <div class="col-md-6">
        <div class="card p-3">
          <h6>Top Proveedores con m√°s reclamos</h6>
          <div id="graf-proveedores">
            {{ graf_proveedores | safe }}
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card p-3">
          <h6>Top Productos m√°s reclamados</h6>
          <div id="graf-productos">
            {{ graf_productos | safe }}
          </div>
        </div>
      </div>
    </div>

    <!-- listados avisos -->
    <div class="card mb-3">
      <div class="card-header bg-warning">
        <strong>‚ö†Ô∏è Avisos detectados (EAN + Lote con reclamos en 2 tiendas)</strong>
      </div>
      <div class="card-body p-0">
        <div id="table-avisos">
          {% if listado_avisos %}
            <table class="table table-sm table-compact mb-0">
              <thead class="table-light">
                <tr>
                  <th>EAN</th>
                  <th>Lote</th>
                  <th>Producto</th>
                  <th>Proveedor</th>
                  <th>Cantidad de tiendas</th>
                </tr>
              </thead>
              <tbody>
                {% for it in listado_avisos %}
                <tr class="row-aviso">
                  <td>{{ it.ean }}</td>
                  <td>{{ it.lote_nro }}</td>
                  <td>{{ it.descripcion if it.descripcion else '' }}</td>
                  <td>{{ it.razon_social if it.razon_social else '' }}</td>
                  <td>{{ it.Cantidad_tiendas }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="no-data">No se detectaron avisos.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- listados alertas -->
    <div class="card mb-3">
      <div class="card-header bg-danger text-white">
        <strong>üö® Alertas detectadas (EAN + Lote con reclamos en 3 o m√°s tiendas)</strong>
      </div>
      <div class="card-body p-0">
        <div id="table-alertas">
          {% if listado_alertas %}
            <table class="table table-sm table-compact mb-0">
              <thead class="table-light">
                <tr>
                  <th>EAN</th>
                  <th>Lote</th>
                  <th>Producto</th>
                  <th>Proveedor</th>
                  <th>Cantidad de tiendas</th>
                </tr>
              </thead>
              <tbody>
                {% for it in listado_alertas %}
                <tr class="row-alerta">
                  <td>{{ it.ean }}</td>
                  <td>{{ it.lote_nro }}</td>
                  <td>{{ it.descripcion if it.descripcion else '' }}</td>
                  <td>{{ it.razon_social if it.razon_social else '' }}</td>
                  <td>{{ it.Cantidad_tiendas }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="no-data">No se detectaron alertas.</div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>

  <script>
    // helper: construir cuerpo para POST
    function buildPayload() {
      const mes = document.getElementById("filter-mes").value;
      const sub = document.getElementById("filter-subtipo").value;
      const def = document.getElementById("filter-def").value;
      return { mes: mes || null, sub_tipo: sub || null, definicion: def || null };
    }

    async function applyFilters() {
      const payload = buildPayload();
      const res = await fetch("/filtrar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.error) {
        alert("Error: " + data.error);
        return;
      }

      // actualizar tarjetas
      document.getElementById("total-reclamos").innerText = data.total_reclamos;
      document.getElementById("total-avisos").innerText = data.total_avisos;
      document.getElementById("total-alertas").innerText = data.total_alertas;
      document.getElementById("proveedor-top").innerText = data.proveedor_top || "-";

      // actualizar graficos (HTML generado por plotly)
      document.getElementById("graf-proveedores").innerHTML = data.graf_proveedores;
      document.getElementById("graf-productos").innerHTML = data.graf_productos;

      // actualizar tablas avisos y alertas
      const renderTable = (containerId, rows) => {
        const cont = document.getElementById(containerId);
        if (!rows || rows.length === 0) {
          cont.innerHTML = '<div class="no-data">No se encontraron registros.</div>';
          return;
        }
        let html = '<table class="table table-sm table-compact mb-0"><thead class="table-light"><tr><th>EAN</th><th>Lote</th><th>Producto</th><th>Proveedor</th><th>Cantidad de tiendas</th></tr></thead><tbody>';
        for (const r of rows) {
          const cls = (r.Cantidad_tiendas >= 3) ? 'row-alerta' : 'row-aviso';
          html += `<tr class="${cls}"><td>${r.ean ?? ''}</td><td>${r.lote_nro ?? ''}</td><td>${r.descripcion ?? ''}</td><td>${r.razon_social ?? ''}</td><td>${r.Cantidad_tiendas ?? ''}</td></tr>`;
        }
        html += '</tbody></table>';
        cont.innerHTML = html;
      };

      renderTable("table-avisos", data.listado_avisos);
      renderTable("table-alertas", data.listado_alertas);
    }

    document.getElementById("btn-apply").addEventListener("click", applyFilters);
    document.getElementById("btn-reset").addEventListener("click", () => {
      document.getElementById("filter-mes").value = "";
      document.getElementById("filter-subtipo").value = "";
      document.getElementById("filter-def").value = "";
      applyFilters();
    });

    // aplicar filtros inicialmente (para asegurar que el plotly se cargue correctamente con tema)
    window.addEventListener("load", () => {
      // nada para forzar al cargar porque ya viene el HTML inicial del servidor.
      // pero podemos refrescar si queremos:
      // applyFilters();
    });
  </script>
</body>
</html>
